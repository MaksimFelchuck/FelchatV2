# Felchat API Tests

–≠—Ç–æ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ Felchat.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ api/                    # –¢–µ—Å—Ç—ã API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ test_users_api.py   # –¢–µ—Å—Ç—ã API –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ test_chat_api.py    # –¢–µ—Å—Ç—ã API —á–∞—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ test_pages_api.py   # –¢–µ—Å—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
‚îú‚îÄ‚îÄ conftest.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest
‚îî‚îÄ‚îÄ README.md              # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤

### üß™ InMem —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
–í—Å–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç InMem (in-memory) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö:
- `InMemUserRepository` - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `InMemChatRepository` - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç PostgreSQL –∏–ª–∏ Redis

### üéØ –ü–æ–∫—Ä—ã—Ç–∏–µ API
–¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

#### Users API (`/users/*`)
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–≤—ã—Ö–æ–¥
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- ‚úÖ –°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

#### Chat API (`/chat/*`)
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

#### Pages API
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
- ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç—ã

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -r requirements-test.txt
```

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
```bash
python run_tests.py
```

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ pytest
```bash
# –í—Å–µ API —Ç–µ—Å—Ç—ã
pytest tests/api/ -v -m api

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
pytest tests/api/test_users_api.py -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
pytest tests/api/ --cov=src --cov-report=html
```

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
```bash
python run_tests.py tests/api/test_users_api.py
```

## –ú–∞—Ä–∫–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

- `@pytest.mark.api` - API —Ç–µ—Å—Ç—ã
- `@pytest.mark.asyncio` - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

## –§–∏–∫—Å—Ç—É—Ä—ã

### `client`
TestClient —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ InMem —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏

### `setup_users`
–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ InMem —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

### `user_service`, `chat_service`
–°–µ—Ä–≤–∏—Å—ã —Å InMem —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏

## –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

### –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```python
def test_register_user_success(self, client: TestClient):
    user_data = {
        "username": "newuser",
        "email": "newuser@example.com",
        "password": "password123"
    }
    
    response = client.post("/users/register", json=user_data)
    
    assert response.status_code == 200
    data = response.json()
    assert data["username"] == user_data["username"]
```

### –¢–µ—Å—Ç —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
```python
def test_authenticated_endpoint(self, client: TestClient, setup_users):
    # –°–Ω–∞—á–∞–ª–∞ –ª–æ–≥–∏–Ω–∏–º—Å—è
    login_data = {"username": "testuser1", "password": "password123"}
    login_response = client.post("/users/login", data=login_data)
    assert login_response.status_code == 200
    
    # –¢–µ–ø–µ—Ä—å —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞—â–∏—â–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
    response = client.get("/users/current")
    assert response.status_code == 200
```

## –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

–¢–µ—Å—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –æ—Ç—á–µ—Ç—ã –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∫–æ–¥–∞:
- –¢–µ—Ä–º–∏–Ω–∞–ª: `--cov-report=term-missing`
- HTML: `--cov-report=html:htmlcov`

–û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `htmlcov/`.

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ø–∞–ø–∫–µ `tests/api/`
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Ä–∫–µ—Ä `@pytest.mark.api`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏–∑ `conftest.py`
4. –î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ docstrings

## –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```bash
pytest tests/api/test_users_api.py -v -s --pdb
```

–§–ª–∞–≥ `-s` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç print() –≤—ã–≤–æ–¥, `--pdb` –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ç–ª–∞–¥—á–∏–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ. 