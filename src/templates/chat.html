{% extends "base.html" %}
{% block title %}Чат{% endblock %}
{% block content %}
<div class="chat-page mx-auto" style="max-width: 600px; width:100%;">
  <h2 class="mb-4 display-6 fw-bold text-center">Чат с {{ other_username }}</h2>
  <div id="chat-history" class="mb-3 p-3 rounded-3 bg-dark-subtle border border-primary-subtle" style="height: 350px; overflow-y: auto;">
    {% for msg in history %}
      <div class="mb-2">
        <span class="fw-bold {% if msg.from == current_user %}text-info{% else %}text-warning{% endif %}">
          {% if msg.from == current_user %}{{ username }}{% else %}{{ other_username }}{% endif %}:
        </span>
        <span>{{ msg.message }}</span>
      </div>
    {% endfor %}
  </div>
  <form id="chat-form" class="d-flex gap-2">
    <input id="chat-input" class="form-control" autocomplete="off" placeholder="Введите сообщение..." />
    <button class="btn btn-primary" type="submit">Отправить</button>
  </form>
</div>
<script>
  const userId = {{ current_user }};
  const username = "{{ username }}";
  const otherUserId = {{ other_user_id }};
  const otherUsername = "{{ other_username }}";
  const ws = new WebSocket(`ws://${location.host}/ws/chat/${otherUserId}`);
  const chatHistory = document.getElementById('chat-history');
  ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const div = document.createElement('div');
    div.classList.add('mb-2');
    const sender = data.from == userId ? username : otherUsername;
    const senderClass = data.from == userId ? 'text-info' : 'text-warning';
    div.innerHTML = `<span class='fw-bold ${senderClass}'>${sender}:</span> <span>${data.message}</span>`;
    chatHistory.appendChild(div);
    chatHistory.scrollTop = chatHistory.scrollHeight;
  };
  document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    if (input.value.trim()) {
      ws.send(input.value);
      input.value = '';
    }
  };
</script>
{% endblock %} 